{% load static %}

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="description" content="SkipTheQueue - Skip the queue at your college canteen">
    <meta name="theme-color" content="#3b82f6">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="apple-mobile-web-app-title" content="SkipTheQueue">
    <title>{% block title %}SkipTheQueue{% endblock %}</title>
    
    <!-- PWA Manifest via routed endpoint -->
    <link rel="manifest" href="{% url 'pwa_manifest' %}">
    
    <!-- Favicon -->
    <link rel="icon" type="image/png" sizes="96x96" href="{% static 'images/icon-96x96.png' %}">
    <link rel="icon" type="image/png" sizes="72x72" href="{% static 'images/icon-72x72.png' %}">
    
    <!-- Apple Touch Icons -->
    <link rel="apple-touch-icon" sizes="152x152" href="{% static 'images/icon-152x152.png' %}">
    
    <!-- CSS -->
    <link rel="stylesheet" href="{% static 'css/main.css' %}">
    
    <!-- Font Awesome for icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    {% block extra_css %}{% endblock %}
</head>
<body>
    <!-- Enhanced Notification System -->
    <div id="notification-container" class="notification-container"></div>
    
    <!-- Order Status Bar Container - Shows on all pages -->
    <div id="order-status-container"></div>
    
    <!-- Order Ready Notification Container - Persistent until dismissed -->
    <div id="order-ready-container"></div>
    
    <!-- Navigation -->
    <nav class="navbar">
        <div class="container">
            <div class="nav-content">
                <a href="{% url 'home' %}" class="nav-logo">
                    <svg viewBox="0 0 24 24" fill="currentColor" class="logo-icon">
                        <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-2 15l-5-5 1.41-1.41L10 14.17l7.59-7.59L19 8l-9 9z"/>
                    </svg>
                    <span class="logo-text">SkipTheQueue</span>
                </a>
                
                <!-- Desktop Navigation -->
                <div class="nav-menu desktop-only">
                    <a href="{% url 'home' %}" class="nav-link">Home</a>
                    <a href="{% url 'menu' %}" class="nav-link">Menu</a>
                    <a href="{% url 'order_history' %}" class="nav-link">Order History</a>
                    <a href="{% url 'help_center' %}" class="nav-link">Help</a>
                </div>
                
                <!-- Mobile Menu Button -->
                <button class="mobile-menu-btn mobile-only" onclick="toggleMobileMenu()" aria-label="Toggle mobile menu">
                    <i class="fas fa-bars"></i>
                </button>
                
                <!-- User Menu -->
                <div class="user-menu">
                    {% if user.is_authenticated %}
                        <div class="user-dropdown" id="userDropdown">
                            <button class="user-dropdown-btn" onclick="toggleUserDropdown()" aria-label="User menu">
                                <i class="fas fa-user"></i>
                                <span class="user-email">{{ user.email|truncatechars:20 }}</span>
                                <i class="fas fa-chevron-down"></i>
                            </button>
                            <div class="user-dropdown-content" id="userDropdownContent">
                                {% if user.is_superuser %}
                                    <a href="{% url 'super_admin_dashboard' %}" class="dropdown-item">
                                        <i class="fas fa-crown"></i> Super Admin
                                    </a>
                                {% elif user.is_staff %}
                                    {% if request.session.college_slug %}
                                        <a href="{% url 'canteen_staff_dashboard' college_slug=request.session.college_slug %}" class="dropdown-item">
                                            <i class="fas fa-utensils"></i> Canteen Dashboard
                                        </a>
                                    {% else %}
                                        <a href="{% url 'canteen_staff_login' %}" class="dropdown-item">
                                            <i class="fas fa-utensils"></i> Canteen Login
                                        </a>
                                    {% endif %}
                                {% else %}
                                    <a href="{% url 'order_history' %}" class="dropdown-item">
                                        <i class="fas fa-history"></i> Order History
                                    </a>
                                    <a href="{% url 'favorites' %}" class="dropdown-item">
                                        <i class="fas fa-heart"></i> Favorites
                                    </a>
                                {% endif %}
                                <a href="{% url 'logout' %}" class="dropdown-item">
                                    <i class="fas fa-sign-out-alt"></i> Logout
                                </a>
                            </div>
                        </div>
                    {% else %}
                        <div class="auth-buttons">
                            <a href="{% url 'custom_login' %}" class="btn btn-secondary">Login</a>
                            <a href="{% url 'register_college' %}" class="btn btn-primary">Register College</a>
                        </div>
                    {% endif %}
                </div>
            </div>
        </div>
        
        <!-- Mobile Menu -->
        <div class="mobile-menu" id="mobileMenu">
            <div class="mobile-menu-header">
                <h3>Menu</h3>
                <button class="mobile-menu-close" onclick="closeMobileMenu()" aria-label="Close menu">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="mobile-menu-content">
                <a href="{% url 'home' %}" class="mobile-nav-link">
                    <i class="fas fa-home"></i>
                    <span>Home</span>
                </a>
                <a href="{% url 'menu' %}" class="mobile-nav-link">
                    <i class="fas fa-utensils"></i>
                    <span>Menu</span>
                </a>
                <a href="{% url 'order_history' %}" class="mobile-nav-link">
                    <i class="fas fa-history"></i>
                    <span>Order History</span>
                </a>
                <a href="{% url 'favorites' %}" class="mobile-nav-link">
                    <i class="fas fa-heart"></i>
                    <span>Favorites</span>
                </a>
                <a href="{% url 'help_center' %}" class="mobile-nav-link">
                    <i class="fas fa-question-circle"></i>
                    <span>Help</span>
                </a>
                {% if user.is_authenticated %}
                    <div class="mobile-user-section">
                        <div class="mobile-user-info">
                            <i class="fas fa-user"></i>
                            <span>{{ user.email|truncatechars:25 }}</span>
                        </div>
                        <a href="{% url 'logout' %}" class="mobile-nav-link mobile-logout">
                            <i class="fas fa-sign-out-alt"></i>
                            <span>Logout</span>
                        </a>
                    </div>
                {% endif %}
            </div>
        </div>
    </nav>

    <!-- Messages -->
    {% if messages %}
        <div class="messages">
            {% for message in messages %}
                <div class="message {{ message.tags }}">
                    <div class="message-content">
                        <i class="message-icon fas fa-{% if message.tags == 'success' %}check-circle{% elif message.tags == 'error' %}exclamation-circle{% elif message.tags == 'warning' %}exclamation-triangle{% else %}info-circle{% endif %}"></i>
                        <span class="message-text">{{ message }}</span>
                    </div>
                    <button class="message-close" onclick="this.parentElement.remove()" aria-label="Close message">Ã—</button>
                </div>
            {% endfor %}
        </div>
    {% endif %}

    <!-- Main Content -->
    <main class="main-content">
        <div class="container">
            {% block content %}{% endblock %}
        </div>
    </main>

    <!-- Footer -->
    <footer class="footer">
        <div class="container">
            <div class="footer-content">
                <div class="footer-grid">
                    <div class="footer-section">
                        <h3>SkipTheQueue</h3>
                        <p>Skip the queue at your college canteen with our innovative ordering system.</p>
                    </div>
                    <div class="footer-section">
                        <h3>Quick Links</h3>
                        <ul>
                            <li><a href="{% url 'home' %}">Home</a></li>
                            <li><a href="{% url 'menu' %}">Menu</a></li>
                            <li><a href="{% url 'help_center' %}">Help Center</a></li>
                        </ul>
                    </div>
                    <div class="footer-section">
                        <h3>Support</h3>
                        <ul>
                            <li><a href="{% url 'help_center' %}">Help Center</a></li>
                            <li><a href="{% url 'terms_of_service' %}">Terms of Service</a></li>
                            <li><a href="{% url 'privacy_policy' %}">Privacy Policy</a></li>
                        </ul>
                    </div>
                    <div class="footer-section">
                        <h3>Contact</h3>
                        <p>Email: support@skipthequeue.app</p>
                        <p>For college registrations: admin@skipthequeue.app</p>
                    </div>
                </div>
                <div class="footer-bottom">
                    <p>&copy; 2024 SkipTheQueue. All rights reserved.</p>
                </div>
            </div>
        </div>
    </footer>

    <!-- User Phone Data (for notifications) -->
    {% if user.is_authenticated %}
        <div data-user-phone="{{ user.userprofile.phone_number|default:'' }}" style="display: none;"></div>
    {% endif %}
    
    <!-- Order Phone Data (for notifications) -->
    {% if order %}
        <div data-order-phone="{{ order.user_phone|default:'' }}" style="display: none;"></div>
    {% endif %}

    <!-- JavaScript -->
    <script src="{% static 'js/notifications.js' %}"></script>
    
    <script>
        // Enhanced mobile menu functionality
        function toggleMobileMenu() {
            const mobileMenu = document.getElementById('mobileMenu');
            const body = document.body;
            
            mobileMenu.classList.toggle('active');
            body.classList.toggle('menu-open');
            
            // Prevent body scroll when menu is open
            if (mobileMenu.classList.contains('active')) {
                body.style.overflow = 'hidden';
            } else {
                body.style.overflow = '';
            }
        }

        function closeMobileMenu() {
            const mobileMenu = document.getElementById('mobileMenu');
            const body = document.body;
            
            mobileMenu.classList.remove('active');
            body.classList.remove('menu-open');
            body.style.overflow = '';
        }

        // Enhanced user dropdown functionality
        function toggleUserDropdown() {
            const dropdown = document.getElementById('userDropdownContent');
            dropdown.classList.toggle('active');
        }

        // Close dropdowns when clicking outside
        document.addEventListener('click', function(event) {
            const userDropdown = document.getElementById('userDropdown');
            const mobileMenu = document.getElementById('mobileMenu');
            
            if (userDropdown && !userDropdown.contains(event.target)) {
                document.getElementById('userDropdownContent').classList.remove('active');
            }
            
            if (mobileMenu && !mobileMenu.contains(event.target) && !event.target.closest('.mobile-menu-btn')) {
                closeMobileMenu();
            }
        });

        // Close mobile menu when clicking on a link
        document.querySelectorAll('.mobile-nav-link').forEach(link => {
            link.addEventListener('click', closeMobileMenu);
        });

        // Close user dropdown when clicking on a link
        document.querySelectorAll('.dropdown-item').forEach(item => {
            item.addEventListener('click', function() {
                document.getElementById('userDropdownContent').classList.remove('active');
            });
        });

        // Initialize notification system with user data
        document.addEventListener('DOMContentLoaded', function() {
            // Store user phone in session storage for notifications
            const userPhoneElement = document.querySelector('[data-user-phone]');
            if (userPhoneElement && userPhoneElement.dataset.userPhone) {
                sessionStorage.setItem('user_phone', userPhoneElement.dataset.userPhone);
            }
            
            // Store order phone in session storage for notifications
            const orderPhoneElement = document.querySelector('[data-order-phone]');
            if (orderPhoneElement && orderPhoneElement.dataset.orderPhone) {
                sessionStorage.setItem('order_phone', orderPhoneElement.dataset.orderPhone);
            }
            
            // Initialize mobile-specific behaviors
            initializeMobileBehaviors();
        });

        // Mobile-specific behaviors
        function initializeMobileBehaviors() {
            // Enhanced touch feedback for mobile
            if ('ontouchstart' in window) {
                document.addEventListener('touchstart', function() {}, {passive: true});
                
                // Add touch feedback to buttons
                document.querySelectorAll('.btn, .nav-link, .mobile-nav-link').forEach(element => {
                    element.addEventListener('touchstart', function() {
                        this.classList.add('touch-active');
                    });
                    
                    element.addEventListener('touchend', function() {
                        this.classList.remove('touch-active');
                    });
                });
            }
            
            // Handle orientation changes
            window.addEventListener('orientationchange', function() {
                setTimeout(function() {
                    // Close mobile menu on orientation change
                    closeMobileMenu();
                    
                    // Refresh viewport
                    const viewport = document.querySelector('meta[name="viewport"]');
                    if (viewport) {
                        viewport.setAttribute('content', 'width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no');
                    }
                }, 100);
            });
        }

        // Service Worker Registration for PWA (use routed endpoint at root)
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', function() {
                navigator.serviceWorker.register('{% url "pwa_service_worker" %}')
                    .then(function(registration) {
                        console.log('ServiceWorker registration successful');
                        
                        // Handle service worker updates
                        registration.addEventListener('updatefound', function() {
                            const newWorker = registration.installing;
                            newWorker.addEventListener('statechange', function() {
                                if (newWorker.state === 'installed' && navigator.serviceWorker.controller) {
                                    // New service worker available, reload page
                                    window.location.reload();
                                }
                            });
                        });
                    })
                    .catch(function(err) {
                        console.log('ServiceWorker registration failed');
                    });
                
                // Listen for messages from service worker
                navigator.serviceWorker.addEventListener('message', function(event) {
                    if (event.data && event.data.type === 'RELOAD_PAGE') {
                        window.location.reload();
                    }
                });
            });
        }

        // Handle back button on mobile
        if (window.history && window.history.pushState) {
            window.addEventListener('popstate', function() {
                closeMobileMenu();
            });
        }
    </script>

    {% block extra_js %}{% endblock %}
</body>
</html>
