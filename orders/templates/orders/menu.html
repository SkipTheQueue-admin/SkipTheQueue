{% extends "orders/base.html" %}
{% block content %}
<!-- Hidden CSRF Token Form for JS fetches -->
<form id="csrf-form" style="display:none">{% csrf_token %}</form>
<main class="container">
  <section class="card mb-8">
    <header class="mb-8 text-center">
      <h1 style="font-size: 2rem; font-weight: 700; color: #2563eb;">Menu</h1>
      {% if college %}
        <p style="color: #4b5563; margin-top: 0.25rem; font-size: 1rem;">{{ college.name }}</p>
      {% endif %}
    </header>
    <form method="get" class="form-group" style="display: flex; gap: 0.5rem;">
      <input type="text" name="search" value="{{ search_query }}" placeholder="Search menu items..." class="input" style="flex: 1;">
      <button type="submit" class="btn btn-primary">Search</button>
    </form>
    <div class="mb-8" style="display: flex; gap: 0.5rem;">
      {% if user.is_authenticated %}
        <a href="{% url 'favorites' %}" class="btn btn-secondary w-full">Favorites</a>
      {% endif %}
      <a href="{% url 'view_cart' %}" class="btn btn-primary w-full">Cart{% if cart_count > 0 %} <span style="background: #dc2626; color: #fff; border-radius: 9999px; padding: 0 0.5rem; margin-left: 0.5rem;">{{ cart_count }}</span>{% endif %}</a>
    </div>
    {% if search_query %}
      <div class="mb-8 text-center" style="color: #4b5563; font-size: 1rem;">
        Search results for <strong>{{ search_query }}</strong> ({{ menu_items|length }} item{{ menu_items|length|pluralize }} found)
        <a href="{% url 'menu' %}" style="color: #2563eb; margin-left: 0.5rem;">Clear search</a>
      </div>
    {% endif %}
    {% if favorite_items %}
      <section class="mb-8">
        <h2 class="mb-4" style="font-size: 1.25rem; font-weight: 700; color: #111827;">Your Favorites</h2>
        <div class="college-grid">
          {% for item in favorite_items %}
            <div class="card" style="padding: 1rem;">
              <h3 style="font-size: 1.1rem; font-weight: 600; color: #111827;">{{ item.name }}</h3>
              <p style="color: #6b7280; font-size: 0.95rem;">{{ item.description|default:"Delicious item from our menu." }}</p>
              <div style="display: flex; justify-content: space-between; align-items: center;">
                <span style="font-size: 1.1rem; font-weight: 700; color: #059669;">₹{{ item.price }}</span>
                <button onclick="addToCart('{{ item.id }}')" class="btn btn-primary">Add to Cart</button>
              </div>
            </div>
          {% endfor %}
        </div>
      </section>
    {% endif %}
    <section>
      <h2 class="mb-4" style="font-size: 1.25rem; font-weight: 700; color: #111827;">All Menu Items</h2>
      {% if menu_items %}
        <div class="college-grid">
          {% for item in menu_items %}
            <div class="card" style="padding: 1rem;">
              <h3 style="font-size: 1.1rem; font-weight: 600; color: #111827;">{{ item.name }}</h3>
              <p style="color: #6b7280; font-size: 0.95rem;">{{ item.description|default:"Delicious item from our menu." }}</p>
              <div style="display: flex; justify-content: space-between; align-items: center;">
                <span style="font-size: 1.1rem; font-weight: 700; color: #059669;">₹{{ item.price }}</span>
                <button onclick="addToCart('{{ item.id }}')" class="btn btn-primary">Add to Cart</button>
              </div>
            </div>
          {% endfor %}
        </div>
      {% else %}
        <div class="text-center mb-8">No menu items found.</div>
      {% endif %}
    </section>
  </section>
</main>

<script>
function getCSRFToken() {
  // Prefer reading CSRF token from the hidden form rendered by Django
  const tokenInput = document.querySelector('#csrf-form input[name="csrfmiddlewaretoken"]');
  if (tokenInput) {
    return tokenInput.value;
  }
  // Fallback to cookie scan if available
  const name = 'csrftoken=';
  const cookies = document.cookie.split(';');
  for (let c of cookies) {
    c = c.trim();
    if (c.indexOf(name) === 0) return decodeURIComponent(c.substring(name.length));
  }
  return null;
}

function addToCart(itemId) {
  const button = event.target.closest('button');
  const originalText = button.textContent;
  button.disabled = true;
  button.textContent = 'Adding...';
  fetch(`/add-to-cart/${itemId}/`, {
    method: 'POST',
    headers: {
      'X-CSRFToken': getCSRFToken() || '',
      'Content-Type': 'application/json'
    }
  })
  .then(r => r.json())
  .then(data => {
    if (data.success) {
      if (typeof updateGlobalCartCount === 'function') {
        updateGlobalCartCount(data.cart_count);
      }
      if (typeof showGlobalNotification === 'function') {
        showGlobalNotification('Added to Cart', data.message || 'Item added', 'success');
      }
      button.textContent = 'Added!';
      setTimeout(() => { button.textContent = originalText; button.disabled = false; }, 1200);
    } else {
      throw new Error(data.error || 'Failed to add item');
    }
  })
  .catch(err => {
    if (typeof showGlobalNotification === 'function') {
      showGlobalNotification('Error', err.message || 'Failed to add item', 'error');
    }
    button.textContent = originalText;
    button.disabled = false;
  });
}

function toggleFavorite(itemId) {
  fetch(`/toggle-favorite/${itemId}/`, {
    method: 'POST',
    headers: {
      'X-CSRFToken': getCSRFToken() || '',
      'Content-Type': 'application/json'
    }
  })
  .then(r => r.json())
  .then(data => {
    if (typeof showGlobalNotification === 'function') {
      showGlobalNotification('Favorites', data.message || 'Updated favorites', data.success ? 'success' : 'info');
    }
  })
  .catch(err => {
    if (typeof showGlobalNotification === 'function') {
      showGlobalNotification('Error', err.message || 'Failed to update favorites', 'error');
    }
  });
}
</script>
{% endblock %}
