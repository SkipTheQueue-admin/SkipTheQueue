{% extends "orders/base.html" %}

<!-- Hidden CSRF Token Form -->
<form id="csrf-form" style="display: none;">
  {% csrf_token %}
</form>

{% block content %}
<main class="container">
  <section class="card mb-8">
    <header class="mb-8 text-center">
      <h1 style="font-size: 2rem; font-weight: 700; color: #2563eb;">Shopping Cart</h1>
      <p><span id="cart-count">{{ cart_items|length }}</span> item{{ cart_items|length|pluralize }}</p>
    </header>
    
    <div class="mb-8" style="display: flex; gap: 0.5rem;">
      <a href="{% url 'menu' %}" class="btn btn-secondary w-full">Continue Shopping</a>
    </div>
    
    {% if cart_items %}
      <!-- Cart Items -->
      <div class="college-grid mb-8">
        {% for entry in cart_items %}
          <div class="card" style="padding: 1rem;">
            <h3 style="font-size: 1.1rem; font-weight: 600; color: #111827;">{{ entry.item.name }}</h3>
            <p style="color: #6b7280; font-size: 0.95rem;">{{ entry.item.description }}</p>
            
            <div style="display: flex; justify-content: space-between; align-items: center; margin-top: 1rem;">
              <span style="font-size: 1.1rem; font-weight: 700; color: #059669;">₹{{ entry.item.price }}</span>
              <span>Qty: {{ entry.quantity }}</span>
              <span class="item-total">₹{{ entry.total|floatformat:2 }}</span>
            </div>
            
            <!-- Cart Item Controls -->
            <div style="display: flex; gap: 0.5rem; margin-top: 1rem; justify-content: center;">
              <button onclick="updateCartQuantity('{{ entry.item.id }}', 'decrease')" class="btn btn-secondary" style="padding: 0.5rem 1rem; min-width: 40px;">-</button>
              <span style="padding: 0.5rem 1rem; background: #f3f4f6; border-radius: 0.375rem; min-width: 40px; text-align: center;">{{ entry.quantity }}</span>
              <button onclick="updateCartQuantity('{{ entry.item.id }}', 'increase')" class="btn btn-secondary" style="padding: 0.5rem 1rem; min-width: 40px;">+</button>
              <button onclick="removeFromCart('{{ entry.item.id }}')" class="btn btn-danger" style="padding: 0.5rem 1rem;">Remove</button>
            </div>
          </div>
        {% endfor %}
      </div>
      
      <!-- Order Summary -->
      <section class="card mb-8">
        <h2 class="mb-4" style="font-size: 1.25rem; font-weight: 700; color: #111827;">Order Summary</h2>
        
        <div style="display: flex; justify-content: space-between; margin-bottom: 0.5rem;">
          <span>Subtotal</span>
          <span>₹<span id="summary-total">{{ total|floatformat:2 }}</span></span>
        </div>
        
        <div style="display: flex; justify-content: space-between; margin-bottom: 0.5rem;">
          <span>Service Charge</span>
          <span>₹0.00</span>
        </div>
        
        <div style="display: flex; justify-content: space-between; font-weight: 700; margin-bottom: 1rem; padding-top: 0.5rem; border-top: 1px solid #e5e7eb;">
          <span>Total</span>
          <span style="color: #2563eb;">₹<span id="summary-grand-total">{{ total|floatformat:2 }}</span></span>
        </div>
        
        {% if user_authenticated %}
          <a href="{% url 'collect_phone' %}" class="btn btn-primary w-full mt-8">Proceed to Order</a>
        {% else %}
          <div class="mb-4 text-center" style="color: #92400e;">Login required to place order</div>
          <a href="{% url 'custom_login' %}?next={{ request.path }}" class="btn btn-primary w-full">Login to Continue</a>
        {% endif %}
      </section>
    {% else %}
      <div class="text-center mb-8">
        <p style="margin-bottom: 1rem; color: #6b7280;">Your cart is empty.</p>
        <a href="{% url 'menu' %}" class="btn btn-primary">Start Shopping</a>
      </div>
    {% endif %}
  </section>
</main>

<!-- Fallback for non-JS users -->
<noscript>
  <div style="background-color: #fee2e2; color: #991b1b; padding: 1rem; border-radius: 0.25rem; margin: 1rem 0; text-align: center;">
    <strong>JavaScript Required:</strong> Please enable JavaScript for the best cart experience, or use the form controls above.
  </div>
</noscript>

<script>
// CSRF Token Management
function getCSRFToken() {
  const tokenInput = document.querySelector('#csrf-form input[name="csrfmiddlewaretoken"]');
  if (tokenInput) {
    return tokenInput.value;
  }
  // Fallback to cookie if available
  const name = 'csrftoken=';
  const cookies = document.cookie.split(';');
  for (let c of cookies) {
    c = c.trim();
    if (c.indexOf(name) === 0) return decodeURIComponent(c.substring(name.length));
  }
  return null;
}

// Update Cart Quantity
function updateCartQuantity(itemId, action) {
  const button = event.target;
  const originalText = button.textContent;
  button.disabled = true;
  button.textContent = '...';
  
  fetch(`/update-cart/${itemId}/`, {
    method: 'POST',
    headers: {
      'X-CSRFToken': getCSRFToken() || '',
      'Content-Type': 'application/x-www-form-urlencoded',
    },
    body: `action=${action}`
  })
  .then(response => {
    if (response.ok) {
      // Reload page to show updated cart
      window.location.reload();
    } else {
      throw new Error('Failed to update cart');
    }
  })
  .catch(error => {
    console.error('Error:', error);
    alert('Failed to update cart. Please try again.');
    button.textContent = originalText;
    button.disabled = false;
  });
}

// Remove Item from Cart
function removeFromCart(itemId) {
  if (!confirm('Are you sure you want to remove this item from your cart?')) {
    return;
  }
  
  const button = event.target;
  const originalText = button.textContent;
  button.disabled = true;
  button.textContent = 'Removing...';
  
  fetch(`/remove_from_cart/${itemId}/`, {
    method: 'POST',
    headers: {
      'X-CSRFToken': getCSRFToken() || '',
      'Content-Type': 'application/x-www-form-urlencoded',
    }
  })
  .then(response => {
    if (response.ok) {
      // Reload page to show updated cart
      window.location.reload();
    } else {
      throw new Error('Failed to remove item');
    }
  })
  .catch(error => {
    console.error('Error:', error);
    alert('Failed to remove item. Please try again.');
    button.textContent = originalText;
    button.disabled = false;
  });
}

// Update cart count display
function updateCartCount(count) {
  const cartCountElement = document.getElementById('cart-count');
  if (cartCountElement) {
    cartCountElement.textContent = count;
  }
}

// Update total display
function updateTotal(total) {
  const totalElement = document.getElementById('summary-total');
  const grandTotalElement = document.getElementById('summary-grand-total');
  if (totalElement) totalElement.textContent = total.toFixed(2);
  if (grandTotalElement) grandTotalElement.textContent = total.toFixed(2);
}
</script>
{% endblock %}

