{% extends "orders/base.html" %}
<!-- eslint-disable -->

{% block content %}
<div style="min-height: 100vh; background: linear-gradient(135deg, #eff6ff 0%, #e0e7ff 100%); padding: 2rem 1rem;">
  <div style="max-width: 64rem; margin: 0 auto;">
    <!-- Header -->
    <div style="text-align: center; margin-bottom: 2rem;">
      <h1 style="font-size: 1.875rem; font-weight: 700; color: #1f2937; margin-bottom: 0.5rem;">My Order History</h1>
      <p style="color: #4b5563;">Track all your past orders and their status</p>
    </div>

    {% if orders %}
      <!-- Order Stats -->
      <div style="display: grid; grid-template-columns: 1fr; gap: 1rem; margin-bottom: 2rem;">
        <div style="background: white; border-radius: 0.5rem; padding: 1rem; box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1);">
          <div style="display: flex; align-items: center;">
            <div style="padding: 0.5rem; background-color: #dbeafe; border-radius: 0.5rem;">
              <svg style="width: 1.5rem; height: 1.5rem; color: #2563eb;" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v10a2 2 0 002 2h8a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2"></path>
              </svg>
            </div>
            <div style="margin-left: 0.75rem;">
              <p style="font-size: 0.875rem; font-weight: 500; color: #4b5563;">Total Orders</p>
              <p style="font-size: 1.125rem; font-weight: 600; color: #111827;">{{ orders.count }}</p>
            </div>
          </div>
        </div>

        <div style="background: white; border-radius: 0.5rem; padding: 1rem; box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1);">
          <div style="display: flex; align-items: center;">
            <div style="padding: 0.5rem; background-color: #dcfce7; border-radius: 0.5rem;">
              <svg style="width: 1.5rem; height: 1.5rem; color: #16a34a;" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
              </svg>
            </div>
            <div style="margin-left: 0.75rem;">
              <p style="font-size: 0.875rem; font-weight: 500; color: #4b5563;">Completed</p>
              <p style="font-size: 1.125rem; font-weight: 600; color: #111827;">{{ orders|length|add:"-2" }}</p>
            </div>
          </div>
        </div>

        <div style="background: white; border-radius: 0.5rem; padding: 1rem; box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1);">
          <div style="display: flex; align-items: center;">
            <div style="padding: 0.5rem; background-color: #fef3c7; border-radius: 0.5rem;">
              <svg style="width: 1.5rem; height: 1.5rem; color: #ca8a04;" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8b4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path>
              </svg>
            </div>
            <div style="margin-left: 0.75rem;">
              <p style="font-size: 0.875rem; font-weight: 500; color: #4b5563;">In Progress</p>
              <p style="font-size: 1.125rem; font-weight: 600; color: #111827;">1</p>
            </div>
          </div>
        </div>

        <div style="background: white; border-radius: 0.5rem; padding: 1rem; box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1);">
          <div style="display: flex; align-items: center;">
            <div style="padding: 0.5rem; background-color: #dbeafe; border-radius: 0.5rem;">
              <svg style="width: 1.5rem; height: 1.5rem; color: #2563eb;" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1"></path>
              </svg>
            </div>
            <div style="margin-left: 0.75rem;">
              <p style="font-size: 0.875rem; font-weight: 500; color: #4b5563;">Total Spent</p>
              <p style="font-size: 1.125rem; font-weight: 600; color: #111827;">â‚¹{{ total_spent|default:"0" }}</p>
            </div>
          </div>
        </div>
      </div>

      <!-- Orders List -->
      <div style="display: flex; flex-direction: column; gap: 1.5rem;">
        {% for order in orders %}
          <div style="background: white; border-radius: 0.75rem; box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1); border: 1px solid #f3f4f6; overflow: hidden; transition: box-shadow 0.3s ease;" data-order-id="{{ order.id }}" data-status="{{ order.status }}">
            <!-- Order Header -->
            <div style="background: linear-gradient(90deg, #eff6ff 0%, #e0e7ff 100%); padding: 1.5rem; border-bottom: 1px solid #f3f4f6;">
              <div style="display: flex; align-items: center; justify-content: space-between;">
                <div style="display: flex; align-items: center; gap: 1rem;">
                  <div style="display: flex; align-items: center;">
                    <span style="font-size: 0.875rem; font-weight: 500; color: #4b5563;">Order #</span>
                    <span style="margin-left: 0.25rem; font-size: 1.125rem; font-weight: 700; color: #111827;">{{ order.id }}</span>
                  </div>
                  <div style="display: flex; align-items: center;">
                    <svg style="width: 1rem; height: 1rem; color: #9ca3af; margin-right: 0.25rem;" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"></path>
                    </svg>
                    <span style="font-size: 0.875rem; color: #4b5563;">{{ order.created_at|date:"M d, Y" }}</span>
                  </div>
                  <div style="display: flex; align-items: center;">
                    <svg style="width: 1rem; height: 1rem; color: #9ca3af; margin-right: 0.25rem;" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                    </svg>
                    <span style="font-size: 0.875rem; color: #4b5563;">{{ order.created_at|date:"H:i" }}</span>
                  </div>
                </div>
                
                <!-- Status Badge -->
                <div style="display: flex; align-items: center;">
                  {% if order.status == 'Pending' %}
                    <span style="display: inline-flex; align-items: center; padding: 0.25rem 0.75rem; border-radius: 9999px; font-size: 0.875rem; font-weight: 500; background-color: #fef3c7; color: #d97706; border: 1px solid #fbbf24;">
                      <svg style="width: 1rem; height: 1rem; margin-right: 0.25rem;" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                      </svg>
                      {{ order.status }}
                    </span>
                  {% elif order.status == 'Paid' %}
                    <span style="display: inline-flex; align-items: center; padding: 0.25rem 0.75rem; border-radius: 9999px; font-size: 0.875rem; font-weight: 500; background-color: #dbeafe; color: #2563eb; border: 1px solid #93c5fd;">
                      <svg style="width: 1rem; height: 1rem; margin-right: 0.25rem;" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                      </svg>
                      {{ order.status }}
                    </span>
                  {% elif order.status == 'In Progress' %}
                    <span style="display: inline-flex; align-items: center; padding: 0.25rem 0.75rem; border-radius: 9999px; font-size: 0.875rem; font-weight: 500; background-color: #fef3c7; color: #ca8a04; border: 1px solid #fbbf24;">
                      <svg style="width: 1rem; height: 1rem; margin-right: 0.25rem;" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"></path>
                      </svg>
                      {{ order.status }}
                    </span>
                  {% elif order.status == 'Ready' %}
                    <span style="display: inline-flex; align-items: center; padding: 0.25rem 0.75rem; border-radius: 9999px; font-size: 0.875rem; font-weight: 500; background-color: #dcfce7; color: #16a34a; border: 1px solid #86efac;">
                      <svg style="width: 1rem; height: 1rem; margin-right: 0.25rem;" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
                      </svg>
                      {{ order.status }}
                    </span>
                  {% elif order.status == 'Completed' %}
                    <span style="display: inline-flex; align-items: center; padding: 0.25rem 0.75rem; border-radius: 9999px; font-size: 0.875rem; font-weight: 500; background-color: #dcfce7; color: #16a34a; border: 1px solid #86efac;">
                      <svg style="width: 1rem; height: 1rem; margin-right: 0.25rem;" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                      </svg>
                      {{ order.status }}
                    </span>
                  {% else %}
                    <span style="display: inline-flex; align-items: center; padding: 0.25rem 0.75rem; border-radius: 9999px; font-size: 0.875rem; font-weight: 500; background-color: #f3f4f6; color: #6b7280; border: 1px solid #d1d5db;">
                      {{ order.status }}
                    </span>
                  {% endif %}
                </div>
              </div>
            </div>

            <!-- Order Details -->
            <div style="padding: 1.5rem;">
              <!-- Customer Info -->
              <div style="display: grid; grid-template-columns: 1fr; gap: 1rem; margin-bottom: 1.5rem;">
                <div style="display: flex; align-items: center;">
                  <svg style="width: 1.25rem; height: 1.25rem; color: #9ca3af; margin-right: 0.5rem;" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path>
                  </svg>
                  <div>
                    <p style="font-size: 0.875rem; color: #4b5563;">Customer</p>
                    <p style="font-weight: 500; color: #111827;">{{ order.user_name }}</p>
                  </div>
                </div>
                
                <div style="display: flex; align-items: center;">
                  <svg style="width: 1.25rem; height: 1.25rem; color: #9ca3af; margin-right: 0.5rem;" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 5a2 2 0 012-2h3.28a1 1 0 01.948.684l1.498 4.493a1 1 0 01-.502 1.21l-2.257 1.13a11.042 11.042 0 005.516 5.516l1.13-2.257a1 1 0 011.21-.502l4.493 1.498a1 1 0 01.684.949V19a2 2 0 01-2 2h-1C9.716 21 3 14.284 3 6V5z"></path>
                  </svg>
                  <div>
                    <p style="font-size: 0.875rem; color: #4b5563;">Phone</p>
                    <p style="font-weight: 500; color: #111827;">{{ order.user_phone }}</p>
                  </div>
                </div>
                
                <div style="display: flex; align-items: center;">
                  <svg style="width: 1.25rem; height: 1.25rem; color: #9ca3af; margin-right: 0.5rem;" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z"></path>
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z"></path>
                  </svg>
                  <div>
                    <p style="font-size: 0.875rem; color: #4b5563;">College</p>
                    <p style="font-weight: 500; color: #111827;">{{ order.college.name|default:"Not specified" }}</p>
                  </div>
                </div>
              </div>

              <!-- Order Items -->
              <div style="margin-bottom: 1.5rem;">
                <h4 style="font-size: 1.125rem; font-weight: 600; color: #1f2937; margin-bottom: 0.75rem;">Order Items</h4>
                <div style="display: flex; flex-direction: column; gap: 0.75rem;">
                  {% for item in order.order_items.all %}
                    <div style="display: flex; align-items: center; justify-content: space-between; padding: 0.75rem; background-color: #f9fafb; border-radius: 0.5rem;">
                      <div style="display: flex; align-items: center;">
                        <div style="width: 2.5rem; height: 2.5rem; background-color: #dbeafe; border-radius: 0.5rem; display: flex; align-items: center; justify-content: center; margin-right: 0.75rem;">
                          <svg style="width: 1.25rem; height: 1.25rem; color: #2563eb;" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4.318 6.318a4.5 4.5 0 000 6.364L12 20.364l7.682-7.682a4.5 4.5 0 00-6.364-6.364L12 7.636l-1.318-1.318a4.5 4.5 0 00-6.364 0z"></path>
                          </svg>
                        </div>
                        <div>
                          <p style="font-weight: 500; color: #111827;">{{ item.item.name }}</p>
                          <p style="font-size: 0.875rem; color: #4b5563;">Quantity: {{ item.quantity }}</p>
                        </div>
                      </div>
                      <div style="text-align: right;">
                        <p style="font-weight: 600; color: #111827;">â‚¹{{ item.price_at_time|floatformat:2 }}</p>
                        <p style="font-size: 0.875rem; color: #4b5563;">â‚¹{{ item.item.price|floatformat:2 }} each</p>
                      </div>
                    </div>
                  {% empty %}
                    <div style="text-align: center; padding: 2rem; color: #6b7280;">
                      <svg style="width: 3rem; height: 3rem; margin: 0 auto 1rem; color: #d1d5db;" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20 13V6a2 2 0 00-2-2H6a2 2 0 00-2 2v7m16 0v5a2 2 0 01-2 2H6a2 2 0 01-2-2v-5m16 0h-2.586a1 1 0 00-.707.293l-2.414 2.414a1 1 0 01-.707.293h-3.172a1 1 0 01-.707-.293l-2.414-2.414A1 1 0 006.586 13H4"></path>
                      </svg>
                      <p>No items found for this order.</p>
                    </div>
                  {% endfor %}
                </div>
              </div>

              <!-- Order Summary -->
              <div style="border-top: 1px solid #e5e7eb; padding-top: 1rem;">
                <div style="display: flex; justify-content: space-between; align-items: center;">
                  <div style="display: flex; flex-direction: column; gap: 0.5rem;">
                    {% if order.special_instructions %}
                      <div style="display: flex; align-items: flex-start;">
                        <svg style="width: 1rem; height: 1rem; color: #9ca3af; margin-right: 0.5rem; margin-top: 0.125rem;" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 8h10M7 12h4m1 8l-4-4H5a2 2 0 01-2-2V6a2 2 0 012-2h14a2 2 0 012 2v8a2 2 0 01-2 2h-3l-4 4z"></path>
                        </svg>
                        <div>
                          <p style="font-size: 0.875rem; font-weight: 500; color: #374151;">Special Instructions</p>
                          <p style="font-size: 0.875rem; color: #4b5563;">{{ order.special_instructions }}</p>
                        </div>
                      </div>
                    {% endif %}
                    
                    <div style="display: flex; align-items: center;">
                      <svg style="width: 1rem; height: 1rem; color: #9ca3af; margin-right: 0.5rem;" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 10h18M7 15h1m4 0h1m-7 4h12a3 3 0 003-3V8a3 3 0 00-3-3H6a3 3 0 00-3 3v8a3 3 0 003 3z"></path>
                      </svg>
                      <span style="font-size: 0.875rem; color: #4b5563;">Payment: {{ order.payment_method }}</span>
                    </div>
                  </div>
                  
                  <div style="text-align: right;">
                    <p style="font-size: 0.875rem; color: #4b5563;">Total Amount</p>
                    <p style="font-size: 1.5rem; font-weight: 700; color: #111827;">â‚¹{{ order.total_price|floatformat:2 }}</p>
                  </div>
                </div>
              </div>

              <!-- Action Buttons -->
              <div style="margin-top: 1.5rem; display: flex; gap: 0.75rem;">
                <a href="{% url 'track_order' %}?order_id={{ order.id }}" 
                   style="flex: 1; background-color: #2563eb; color: white; padding: 0.5rem 1rem; border-radius: 0.5rem; text-decoration: none; text-align: center; font-weight: 500; transition: background-color 0.2s;">
                  Track Order
                </a>
                {% if order.status == 'Completed' %}
                  <button style="flex: 1; background-color: #16a34a; color: white; padding: 0.5rem 1rem; border-radius: 0.5rem; font-weight: 500; transition: background-color 0.2s;">
                    Reorder
                  </button>
                {% endif %}
              </div>
            </div>
          </div>
        {% endfor %}
      </div>
    {% else %}
      <!-- Empty State -->
      <div style="text-align: center; padding: 4rem 0;">
        <div style="width: 6rem; height: 6rem; background-color: #f3f4f6; border-radius: 50%; display: flex; align-items: center; justify-content: center; margin: 0 auto 1.5rem;">
          <svg style="width: 3rem; height: 3rem; color: #9ca3af;" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v10a2 2 0 002 2h8a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2"></path>
          </svg>
        </div>
        <h3 style="font-size: 1.25rem; font-weight: 600; color: #111827; margin-bottom: 0.5rem;">No Orders Yet</h3>
        <p style="color: #4b5563; margin-bottom: 2rem;">You haven't placed any orders yet. Start by browsing our menu!</p>
        <a href="{% url 'menu' %}" 
           style="display: inline-flex; align-items: center; padding: 0.75rem 1.5rem; background-color: #2563eb; color: white; font-weight: 500; border-radius: 0.5rem; text-decoration: none; transition: background-color 0.2s;">
          <svg style="width: 1.25rem; height: 1.25rem; margin-right: 0.5rem;" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path>
          </svg>
          Browse Menu
        </a>
      </div>
    {% endif %}
  </div>
</div>

<script>
/* eslint-disable */
// Real-time order status checking for all orders
let orderStatuses = {};

// Initialize order statuses
document.addEventListener('DOMContentLoaded', function() {
  const statusElements = document.querySelectorAll('.status-badge');
  statusElements.forEach(element => {
    const orderId = element.closest('[data-order-id]')?.dataset.orderId;
    if (orderId) {
      orderStatuses[orderId] = element.textContent.trim();
    }
  });
});

function checkAllOrderStatuses() {
  // Get all pending orders
  const pendingOrders = document.querySelectorAll('[data-status="Pending"], [data-status="Paid"], [data-status="In Progress"]');
  
  if (pendingOrders.length === 0) return;
  
  // Check each pending order
  pendingOrders.forEach(orderElement => {
    const orderId = orderElement.dataset.orderId;
    if (!orderId) return;
    
    fetch(`{% url 'track_order' %}?order_id=${orderId}`)
      .then(response => response.text())
      .then(html => {
        const parser = new DOMParser();
        const doc = parser.parseFromString(html, 'text/html');
        const newStatusElement = doc.querySelector('.status-badge');
        
        if (newStatusElement) {
          const newStatus = newStatusElement.textContent.trim();
          const oldStatus = orderStatuses[orderId];
          
          if (newStatus !== oldStatus) {
            orderStatuses[orderId] = newStatus;
            
            // Show notification for status changes
            if (typeof showGlobalNotification === 'function') {
              if (newStatus === 'Ready') {
                showGlobalNotification(
                  'Order Ready! ðŸŽ‰',
                  `Your order #${orderId} is ready for pickup!`,
                  'success'
                );
              } else if (newStatus === 'In Progress') {
                showGlobalNotification(
                  'Order Being Prepared ðŸ‘¨â€ðŸ³',
                  `Your order #${orderId} is being prepared.`,
                  'info'
                );
              } else if (newStatus === 'Completed') {
                showGlobalNotification(
                  'Order Completed âœ…',
                  `Your order #${orderId} has been completed.`,
                  'success'
                );
              }
            }
            
            // Reload page to show updated status
            setTimeout(() => window.location.reload(), 2000);
          }
        }
      })
      .catch(error => console.log('Status check failed:', error));
  });
}

// Check status every 15 seconds
setInterval(checkAllOrderStatuses, 15000);

// Add smooth scrolling for better UX
document.querySelectorAll('a[href^="#"]').forEach(anchor => {
  anchor.addEventListener('click', function (e) {
    e.preventDefault();
    document.querySelector(this.getAttribute('href')).scrollIntoView({
      behavior: 'smooth'
    });
  });
});
</script>
{% endblock %}
