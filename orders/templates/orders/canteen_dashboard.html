{% extends "orders/base.html" %}

{% block content %}
<!-- CSRF Token - Must be at the top for JavaScript access -->
{% csrf_token %}
<!-- Meta tag for JavaScript access to CSRF token -->
<meta name="csrf-token" content="{{ csrf_token }}">

<div class="min-h-screen bg-gradient-to-br from-blue-900 via-purple-900 to-indigo-900">
  <!-- Header -->
  <div class="bg-white/10 backdrop-blur-lg border-b border-white/20">
    <div class="max-w-7xl mx-auto px-4 py-4">
      <div class="flex flex-col lg:flex-row lg:items-center lg:justify-between gap-4">
        <div class="flex items-center space-x-3">
          <div class="w-12 h-12 bg-gradient-to-r from-blue-500 to-purple-600 rounded-xl flex items-center justify-center">
            <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4"></path>
            </svg>
          </div>
          <div>
            <h1 class="text-xl font-bold text-white">{{ college.name }}</h1>
            <p class="text-blue-200 text-sm">Canteen Dashboard</p>
          </div>
        </div>
        
        <div class="flex flex-col sm:flex-row items-start sm:items-center gap-3">
          <div class="bg-green-500/20 backdrop-blur-sm rounded-lg px-3 py-1">
            <span class="text-green-300 text-sm font-medium">ðŸŸ¢ Live</span>
          </div>
          
          <!-- Navigation Links -->
          <div class="flex flex-wrap gap-2">
            <a href="{% url 'canteen_manage_menu' college.slug %}" class="bg-white/10 hover:bg-white/20 backdrop-blur-sm rounded-lg px-4 py-2 text-white text-sm font-medium transition duration-200">
              <svg class="w-4 h-4 inline mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 10h16M4 14h16M4 18h16"></path>
              </svg>
              Menu
            </a>
            <a href="{% url 'canteen_order_history' college.slug %}" class="bg-white/10 hover:bg-white/20 backdrop-blur-sm rounded-lg px-4 py-2 text-white text-sm font-medium transition duration-200">
              <svg class="w-4 h-4 inline mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v10a2 2 0 002 2h8a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2"></path>
              </svg>
              History
            </a>
            <a href="{% url 'canteen_staff_logout' %}" class="bg-red-500/20 hover:bg-red-500/30 backdrop-blur-sm rounded-lg px-4 py-2 text-red-200 text-sm font-medium transition duration-200">
              <svg class="w-4 h-4 inline mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1"></path>
              </svg>
              Logout
            </a>
          </div>
          
          <button onclick="location.reload()" class="bg-white/10 hover:bg-white/20 backdrop-blur-sm rounded-lg p-2 transition duration-200">
            <svg class="w-5 h-5 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path>
            </svg>
          </button>
        </div>
      </div>
    </div>
  </div>

  <div class="max-w-7xl mx-auto px-4 py-6">
    <!-- Loading Indicator -->
    <div id="loading-indicator" class="hidden fixed top-4 left-1/2 transform -translate-x-1/2 z-50 bg-blue-600 text-white px-6 py-3 rounded-lg shadow-lg">
      <div class="flex items-center">
        <svg class="animate-spin -ml-1 mr-3 h-5 w-5 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
          <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
          <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
        </svg>
        <span>Processing...</span>
      </div>
    </div>
    
    <!-- Stats Cards -->
    <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-8">
      <div class="bg-white/10 backdrop-blur-lg rounded-2xl p-6 border border-white/20">
        <div class="flex items-center justify-between">
          <div>
            <p class="text-blue-200 text-sm">Pending Orders</p>
            <p class="text-3xl font-bold text-white">{{ pending_orders|length }}</p>
          </div>
          <div class="w-12 h-12 bg-orange-500/20 rounded-xl flex items-center justify-center">
            <svg class="w-6 h-6 text-orange-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path>
            </svg>
          </div>
        </div>
      </div>
      
      <div class="bg-white/10 backdrop-blur-lg rounded-2xl p-6 border border-white/20">
        <div class="flex items-center justify-between">
          <div>
            <p class="text-blue-200 text-sm font-medium">Today's Orders</p>
            <p class="text-3xl font-bold text-white drop-shadow-lg">{{ total_today }}</p>
          </div>
          <div class="w-12 h-12 bg-blue-500/20 rounded-xl flex items-center justify-center">
            <svg class="w-6 h-6 text-blue-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v10a2 2 0 002 2h8a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2"></path>
            </svg>
          </div>
        </div>
      </div>
      
      <div class="bg-white/10 backdrop-blur-lg rounded-2xl p-6 border border-white/20">
        <div class="flex items-center justify-between">
          <div>
            <p class="text-blue-200 text-sm font-medium">In Progress</p>
            <p class="text-3xl font-bold text-white drop-shadow-lg">{{ in_progress_orders|length }}</p>
          </div>
          <div class="w-12 h-12 bg-yellow-500/20 rounded-xl flex items-center justify-center">
            <svg class="w-6 h-6 text-yellow-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"></path>
            </svg>
          </div>
        </div>
      </div>
      
      <div class="bg-white/10 backdrop-blur-lg rounded-2xl p-6 border border-white/20">
        <div class="flex items-center justify-between">
          <div>
            <p class="text-blue-200 text-sm font-medium">Ready Orders</p>
            <p class="text-3xl font-bold text-white drop-shadow-lg">{{ ready_orders|length }}</p>
          </div>
          <div class="w-12 h-12 bg-green-500/20 rounded-xl flex items-center justify-center">
            <svg class="w-6 h-6 text-green-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
            </svg>
          </div>
        </div>
      </div>
    </div>

    <!-- Pending Orders Section -->
    {% if pending_orders %}
      <div class="mb-8">
        <h2 class="text-2xl font-bold text-white mb-6 flex items-center">
          <svg class="w-6 h-6 mr-2 text-orange-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path>
          </svg>
          Pending Orders ({{ pending_orders|length }})
        </h2>
        
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
          {% for order in pending_orders %}
            <div class="bg-white/10 backdrop-blur-lg rounded-2xl p-6 border border-white/20 hover:bg-white/20 transition duration-200" data-order-id="{{ order.id }}">
              <div class="flex items-start justify-between mb-4">
                <div>
                  <h3 class="text-lg font-semibold text-white">Order #{{ order.id }}</h3>
                  <p class="text-blue-200 text-sm">{{ order.user_name }}</p>
                  <p class="text-blue-200 text-sm">{{ order.user_phone }}</p>
                  <p class="text-blue-200 text-xs">{{ order.created_at|date:"M d, Y H:i" }}</p>
                </div>
                <div class="text-right">
                  <span class="inline-flex items-center px-3 py-1 rounded-full text-sm font-medium bg-orange-500/20 text-orange-300">
                    Pending
                  </span>
                  <p class="text-white font-semibold mt-2">â‚¹{{ order.total_price }}</p>
                </div>
              </div>
              
              <!-- Order Items -->
              <div class="mb-4">
                <h4 class="text-sm font-medium text-blue-200 mb-2">Items:</h4>
                <div class="space-y-1">
                  {% for item in order.order_items.all %}
                    <div class="flex justify-between text-sm">
                      <span class="text-white">{{ item.menu_item.name }} Ã— {{ item.quantity }}</span>
                      <span class="text-blue-200">â‚¹{{ item.total_price }}</span>
                    </div>
                  {% endfor %}
                </div>
              </div>
              
              <!-- Action Buttons -->
              <div class="flex gap-3">
                <button onclick="acceptOrder('{{ order.id }}')" 
                        class="accept-btn flex-1 bg-gradient-to-r from-green-500 to-green-600 hover:from-green-600 hover:to-green-700 text-white py-3 px-4 rounded-lg font-medium transition duration-200"
                        data-order-id="{{ order.id }}">
                  <i class="fas fa-check mr-2"></i>Accept Order
                </button>
                <button onclick="declineOrder('{{ order.id }}')" 
                        class="decline-btn flex-1 bg-gradient-to-r from-red-500 to-red-600 hover:from-red-600 hover:to-red-700 text-white py-3 px-4 rounded-lg font-medium transition duration-200"
                        data-order-id="{{ order.id }}">
                  <i class="fas fa-times mr-2"></i>Decline
                </button>
              </div>
            </div>
          {% endfor %}
        </div>
      </div>
    {% endif %}

    <!-- In Progress Orders Section -->
    {% if in_progress_orders %}
      <div class="mb-8">
        <h2 class="text-2xl font-bold text-white mb-6 flex items-center">
          <svg class="w-6 h-6 mr-2 text-yellow-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"></path>
          </svg>
          In Progress ({{ in_progress_orders|length }})
        </h2>
        
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
          {% for order in in_progress_orders %}
            <div class="bg-white/10 backdrop-blur-lg rounded-2xl p-6 border border-white/20 hover:bg-white/20 transition duration-200" data-order-id="{{ order.id }}">
              <div class="flex items-start justify-between mb-4">
                <div>
                  <h3 class="text-lg font-semibold text-white">Order #{{ order.id }}</h3>
                  <p class="text-blue-200 text-sm">{{ order.user_name }}</p>
                  <p class="text-blue-200 text-sm">{{ order.user_phone }}</p>
                  <p class="text-blue-200 text-xs">{{ order.created_at|date:"M d, Y H:i" }}</p>
                </div>
                <div class="text-right">
                  <span class="inline-flex items-center px-3 py-1 rounded-full text-sm font-medium bg-yellow-500/20 text-yellow-300">
                    In Progress
                  </span>
                  <p class="text-white font-semibold mt-2">â‚¹{{ order.total_price }}</p>
                </div>
              </div>
              
              <!-- Order Items -->
              <div class="mb-4">
                <h4 class="text-sm font-medium text-blue-200 mb-2">Items:</h4>
                <div class="space-y-1">
                  {% for item in order.order_items.all %}
                    <div class="flex justify-between text-sm">
                      <span class="text-white">{{ item.menu_item.name }} Ã— {{ item.quantity }}</span>
                      <span class="text-blue-200">â‚¹{{ item.total_price }}</span>
                    </div>
                  {% endfor %}
                </div>
              </div>
              
              <!-- Action Buttons -->
              <div class="flex gap-3">
                <button onclick="markOrderReady('{{ order.id }}')" 
                        class="mark-ready-btn flex-1 bg-gradient-to-r from-blue-500 to-blue-600 hover:from-blue-600 hover:to-blue-700 text-white py-3 px-4 rounded-lg font-medium transition duration-200 disabled:opacity-50 disabled:cursor-not-allowed"
                        data-order-id="{{ order.id }}">
                  <i class="fas fa-check-circle mr-2"></i>Mark Ready
                </button>
              </div>
            </div>
          {% endfor %}
        </div>
      </div>
    {% endif %}

    <!-- Ready Orders Section -->
    {% if ready_orders %}
      <div class="mb-8">
        <h2 class="text-2xl font-bold text-white mb-6 flex items-center">
          <svg class="w-6 h-6 mr-2 text-green-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
          </svg>
          Ready for Pickup ({{ ready_orders|length }})
        </h2>
        
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
          {% for order in ready_orders %}
            <div class="bg-white/10 backdrop-blur-lg rounded-2xl p-6 border border-white/20 hover:bg-white/20 transition duration-200" data-order-id="{{ order.id }}">
              <div class="flex items-start justify-between mb-4">
                <div>
                  <h3 class="text-lg font-semibold text-white">Order #{{ order.id }}</h3>
                  <p class="text-blue-200 text-sm">{{ order.user_name }}</p>
                  <p class="text-blue-200 text-sm">{{ order.user_phone }}</p>
                  <p class="text-blue-200 text-xs">{{ order.created_at|date:"M d, Y H:i" }}</p>
                </div>
                <div class="text-right">
                  <span class="inline-flex items-center px-3 py-1 rounded-full text-sm font-medium bg-green-500/20 text-green-300">
                    Ready
                  </span>
                  <p class="text-white font-semibold mt-2">â‚¹{{ order.total_price }}</p>
                </div>
              </div>
              
              <!-- Order Items -->
              <div class="mb-4">
                <h4 class="text-sm font-medium text-blue-200 mb-2">Items:</h4>
                <div class="space-y-1">
                  {% for item in order.order_items.all %}
                    <div class="flex justify-between text-sm">
                      <span class="text-white">{{ item.menu_item.name }} Ã— {{ item.quantity }}</span>
                      <span class="text-blue-200">â‚¹{{ item.total_price }}</span>
                    </div>
                  {% endfor %}
                </div>
              </div>
              
              <!-- Action Buttons -->
              <div class="flex gap-3">
                <button onclick="markOrderCompleted('{{ order.id }}')" 
                        class="complete-order-btn flex-1 bg-gradient-to-r from-purple-500 to-purple-600 hover:from-purple-600 hover:to-purple-700 text-white py-3 px-4 rounded-lg font-medium transition duration-200"
                        data-order-id="{{ order.id }}">
                  <i class="fas fa-check-double mr-2"></i>Mark Completed
                </button>
              </div>
            </div>
          {% endfor %}
        </div>
      </div>
    {% endif %}

    <!-- No Orders Message -->
    {% if not pending_orders and not in_progress_orders and not ready_orders %}
      <div class="text-center py-16">
        <div class="w-24 h-24 bg-white/10 rounded-full flex items-center justify-center mx-auto mb-6">
          <svg class="w-12 h-12 text-white/50" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v10a2 2 0 002 2h8a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2"></path>
          </svg>
        </div>
        <h3 class="text-xl font-semibold text-white mb-2">No active orders</h3>
        <p class="text-blue-200">All caught up! No orders to process at the moment.</p>
      </div>
    {% endif %}
  </div>
</div>

<script>
  // Performance-optimized JavaScript for canteen dashboard
  
  // Cache DOM elements and constants for better performance
  const CACHE = {
    csrfToken: null,
    loadingIndicator: null,
    refreshTimer: null,
    isRefreshing: false
  };
  
  // Debounce function to prevent excessive function calls
  function debounce(func, wait) {
    let timeout;
    return function executedFunction(...args) {
      const later = () => {
        clearTimeout(timeout);
        func(...args);
      };
      clearTimeout(timeout);
      timeout = setTimeout(later, wait);
    };
  }
  
  // Initialize dashboard on DOM load
  document.addEventListener('DOMContentLoaded', function() {
    initializeDashboard();
  });
  
  function initializeDashboard() {
    // Cache frequently used DOM elements - get CSRF token from meta tag
    CACHE.csrfToken = document.querySelector('meta[name="csrf-token"]')?.getAttribute('content') || 
                      document.querySelector('[name=csrfmiddlewaretoken]')?.value;
    CACHE.loadingIndicator = document.getElementById('loading-indicator');
    
    if (!CACHE.csrfToken) {
      console.error('CSRF token not found on page load');
      showNotification('Security configuration error. Please refresh the page.', 'error');
      return;
    }
    
    console.log('Canteen dashboard initialized successfully');
    
    // Start smart auto-refresh
    startSmartRefresh();
  }
  
  // Smart auto-refresh that only refreshes when no operations are in progress
  function startSmartRefresh() {
    CACHE.refreshTimer = setInterval(() => {
      if (!CACHE.isRefreshing) {
        // Use fetch instead of location.reload() for better UX
        fetch(window.location.href, {
          method: 'GET',
          headers: {
            'X-Requested-With': 'XMLHttpRequest'
          }
        }).then(response => {
          if (response.ok) {
            // Check if there are new orders by comparing order counts
            const currentPendingCount = document.querySelectorAll('[data-order-id]').length;
            // Only reload if there might be new orders
            if (currentPendingCount > 0) {
              location.reload();
            }
          }
        }).catch(error => {
          console.log('Auto-refresh check failed:', error);
        });
      } else {
        console.log('Skipping auto-refresh - operations in progress');
      }
    }, 60000);  // Increased to 60 seconds for better performance
  }
  
  // Function to accept order - optimized with debouncing and validation
  const acceptOrder = debounce(async function(orderId) {
    if (CACHE.isRefreshing) return;
    
    // Validate order ID
    if (!orderId || isNaN(parseInt(orderId))) {
      showNotification('Invalid order ID', 'error');
      return;
    }
    
    CACHE.isRefreshing = true;
    showLoading();
    
    const orderElement = document.querySelector(`[data-order-id="${orderId}"]`);
    const button = orderElement?.querySelector('.accept-btn');
    
    if (button) {
      button.disabled = true;
      button.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Accepting...';
      button.setAttribute('aria-label', 'Accepting order...');
    }
    
    try {
      const response = await fetch(`/canteen/dashboard/{{ college.slug }}/accept-order/${orderId}/`, {
        method: 'POST',
        headers: {
          'X-Requested-With': 'XMLHttpRequest',
          'Content-Type': 'application/x-www-form-urlencoded',
          'X-CSRFToken': CACHE.csrfToken
        },
        credentials: 'same-origin'
      });
      
      if (response.ok) {
        const data = await response.json();
        if (data.success) {
          showNotification('Order accepted successfully!', 'success');
          setTimeout(() => location.reload(), 1000);
        } else {
          showNotification(data.error || 'Failed to accept order', 'error');
          resetButton(button, 'Accept Order', 'fas fa-check');
        }
      } else {
        showNotification('Failed to accept order', 'error');
        resetButton(button, 'Accept Order', 'fas fa-check');
      }
    } catch (error) {
      console.error('Error accepting order:', error);
      showNotification('Error accepting order', 'error');
      resetButton(button, 'Accept Order', 'fas fa-check');
    } finally {
      hideLoading();
      CACHE.isRefreshing = false;
    }
  }, 300);
  
  // Function to decline order - optimized with debouncing and validation
  const declineOrder = debounce(async function(orderId) {
    if (CACHE.isRefreshing) return;
    
    // Validate order ID
    if (!orderId || isNaN(parseInt(orderId))) {
      showNotification('Invalid order ID', 'error');
      return;
    }
    
    if (!confirm('Are you sure you want to decline this order?')) return;
    
    CACHE.isRefreshing = true;
    
    const orderElement = document.querySelector(`[data-order-id="${orderId}"]`);
    const button = orderElement?.querySelector('.decline-btn');
    
    if (button) {
      button.disabled = true;
      button.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Declining...';
      button.setAttribute('aria-label', 'Declining order...');
    }
    
    try {
      const response = await fetch(`/canteen/dashboard/{{ college.slug }}/decline-order/${orderId}/`, {
        method: 'POST',
        headers: {
          'X-Requested-With': 'XMLHttpRequest',
          'Content-Type': 'application/x-www-form-urlencoded',
          'X-CSRFToken': CACHE.csrfToken
        },
        credentials: 'same-origin'
      });
      
      if (response.ok) {
        const data = await response.json();
        if (data.success) {
          showNotification('Order declined successfully!', 'success');
          setTimeout(() => location.reload(), 1000);
        } else {
          showNotification(data.error || 'Failed to decline order', 'error');
          resetButton(button, 'Decline', 'fas fa-times');
        }
      } else {
        showNotification('Failed to decline order', 'error');
        resetButton(button, 'Decline', 'fas fa-times');
      }
    } catch (error) {
      console.error('Error declining order:', error);
      showNotification('Error declining order', 'error');
      resetButton(button, 'Decline', 'fas fa-times');
    } finally {
      CACHE.isRefreshing = false;
    }
  }, 300);
  
  // Function to mark order as ready - optimized with debouncing and validation
  const markOrderReady = debounce(async function(orderId) {
    if (CACHE.isRefreshing) return;
    
    // Validate order ID
    if (!orderId || isNaN(parseInt(orderId))) {
      showNotification('Invalid order ID', 'error');
      return;
    }
    
    CACHE.isRefreshing = true;
    
    const orderElement = document.querySelector(`[data-order-id="${orderId}"]`);
    const button = orderElement?.querySelector('.mark-ready-btn');
    
    if (button) {
      button.disabled = true;
      button.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Updating...';
      button.setAttribute('aria-label', 'Marking order as ready...');
    }
    
    try {
      const response = await fetch(`/canteen/dashboard/{{ college.slug }}/update-status/${orderId}/`, {
        method: 'POST',
        headers: {
          'X-Requested-With': 'XMLHttpRequest',
          'Content-Type': 'application/x-www-form-urlencoded',
          'X-CSRFToken': CACHE.csrfToken
        },
        body: `status=Ready`,
        credentials: 'same-origin'
      });
      
      if (response.ok) {
        const data = await response.json();
        if (data.success) {
          showNotification('Order marked as ready! Customer will be notified.', 'success');
          setTimeout(() => location.reload(), 1000);
        } else {
          showNotification(data.error || 'Failed to update order status', 'error');
          resetButton(button, 'Mark Ready', 'fas fa-check-circle');
        }
      } else {
        showNotification('Failed to update order status', 'error');
        resetButton(button, 'Mark Ready', 'fas fa-check-circle');
      }
    } catch (error) {
      console.error('Error updating order status:', error);
      showNotification('Error updating order status', 'error');
      resetButton(button, 'Mark Ready', 'fas fa-check-circle');
    } finally {
      CACHE.isRefreshing = false;
    }
  }, 300);
  
  // Function to mark order as completed - optimized with debouncing and validation
  const markOrderCompleted = debounce(async function(orderId) {
    if (CACHE.isRefreshing) return;
    
    // Validate order ID
    if (!orderId || isNaN(parseInt(orderId))) {
      showNotification('Invalid order ID', 'error');
      return;
    }
    
    CACHE.isRefreshing = true;
    
    const orderElement = document.querySelector(`[data-order-id="${orderId}"]`);
    const button = orderElement?.querySelector('.complete-order-btn');
    
    if (button) {
      button.disabled = true;
      button.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Updating...';
      button.setAttribute('aria-label', 'Marking order as completed...');
    }
    
    try {
      const response = await fetch(`/canteen/dashboard/{{ college.slug }}/update-status/${orderId}/`, {
        method: 'POST',
        headers: {
          'X-Requested-With': 'XMLHttpRequest',
          'Content-Type': 'application/x-www-form-urlencoded',
          'X-CSRFToken': CACHE.csrfToken
        },
        body: `status=Completed`,
        credentials: 'same-origin'
      });
      
      if (response.ok) {
        const data = await response.json();
        if (data.success) {
          showNotification('Order marked as completed!', 'success');
          setTimeout(() => location.reload(), 1000);
        } else {
          showNotification(data.error || 'Failed to update order status', 'error');
          resetButton(button, 'Mark Completed', 'fas fa-check-double');
        }
      } else {
        showNotification('Failed to update order status', 'error');
        resetButton(button, 'Mark Completed', 'fas fa-check-double');
      }
    } catch (error) {
      console.error('Error updating order status:', error);
      showNotification('Error updating order status', 'error');
      resetButton(button, 'Mark Completed', 'fas fa-check-double');
    } finally {
      CACHE.isRefreshing = false;
    }
  }, 300);
  
  // Utility function to reset button state
  function resetButton(button, text, iconClass) {
    if (button) {
      button.disabled = false;
      button.innerHTML = `<i class="${iconClass} mr-2"></i>${text}`;
    }
  }
  
  // Optimized notification system
  function showNotification(message, type = 'info') {
    if (typeof window.showNotification === 'function') {
      window.showNotification(message, type);
    } else {
      // Enhanced fallback notification with better performance
      const notification = document.createElement('div');
      const bgColor = type === 'success' ? 'bg-green-500' : type === 'error' ? 'bg-red-500' : 'bg-blue-500';
      const icon = type === 'success' ? 'âœ“' : type === 'error' ? 'âœ—' : 'â„¹';
      
      notification.className = `fixed top-4 right-4 z-50 p-4 rounded-lg shadow-lg max-w-sm ${bgColor} text-white transform transition-all duration-300 translate-x-full`;
      notification.innerHTML = `
        <div class="flex items-center">
          <span class="mr-2 text-lg">${icon}</span>
          <span class="flex-1">${message}</span>
          <button onclick="this.parentElement.parentElement.remove()" class="ml-3 text-white hover:text-gray-200 transition-colors">
            <i class="fas fa-times"></i>
          </button>
        </div>
      `;
      document.body.appendChild(notification);
      
      // Use requestAnimationFrame for better performance
      requestAnimationFrame(() => {
        notification.classList.remove('translate-x-full');
      });
      
      // Auto remove after 5 seconds
      setTimeout(() => {
        if (notification.parentElement) {
          notification.classList.add('translate-x-full');
          setTimeout(() => {
            if (notification.parentElement) {
              notification.remove();
            }
          }, 300);
        }
      }, 5000);
    }
  }
  
  // Optimized loading state management
  function showLoading() {
    if (CACHE.loadingIndicator) {
      CACHE.loadingIndicator.classList.remove('hidden');
    }
  }
  
  function hideLoading() {
    if (CACHE.loadingIndicator) {
      CACHE.loadingIndicator.classList.add('hidden');
    }
  }
  
  // Global error handlers with better performance
  window.addEventListener('error', function(e) {
    console.error('Global error in canteen dashboard:', e.error);
    showNotification('An unexpected error occurred. Please check the console.', 'error');
  });
  
  window.addEventListener('unhandledrejection', function(e) {
    console.error('Unhandled promise rejection in canteen dashboard:', e.reason);
    showNotification('A network error occurred. Please try again.', 'error');
  });
  
  // Cleanup on page unload
  window.addEventListener('beforeunload', () => {
    if (CACHE.refreshTimer) {
      clearInterval(CACHE.refreshTimer);
    }
  });
</script>

{% endblock %}
