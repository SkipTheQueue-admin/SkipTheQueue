{% extends "orders/base.html" %}
{% load static %}

{% block content %}
<!-- Enhanced Order Status Bar - Shows active order status with persistent notifications -->
<div id="order-status-container" style="display: none;">
  <div class="order-status-bar" id="order-status-bar">
    <div class="container">
      <div class="status-content">
        <div class="status-info">
          <div class="status-icon">
            <svg width="20" height="20" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path>
            </svg>
          </div>
          <div>
            <div id="status-title" style="font-weight: 600; margin-bottom: 0.25rem;">Order Status</div>
            <div id="status-message" style="font-size: 0.875rem; opacity: 0.9;">Checking order status...</div>
          </div>
        </div>
        <button class="status-close" onclick="hideOrderStatus()">
          <svg width="16" height="16" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
          </svg>
        </button>
      </div>
    </div>
  </div>
</div>

<!-- Persistent Order Ready Notification (won't auto-dismiss) -->
<div id="order-ready-notification" class="order-ready-notification" style="display: none;">
  <div class="container">
    <div class="notification-content">
      <div class="notification-icon">
        <svg width="24" height="24" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
        </svg>
      </div>
      <div class="notification-text">
        <h4 id="ready-notification-title">ðŸŽ‰ Order Ready for Pickup!</h4>
        <p id="ready-notification-message">Your order is ready for pickup!</p>
      </div>
      <button class="notification-close" onclick="dismissOrderReadyNotification()">
        <svg width="16" height="16" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
        </svg>
      </button>
    </div>
  </div>
</div>

<div class="hero">
  <div class="container">
    <h1>Skip The Queue</h1>
    <p>
      Order your favorite meals from your college canteen without waiting in long queues. 
      Fast, convenient, and delicious food at your fingertips.
    </p>
    
    <!-- College Selection -->
    {% if colleges %}
      <div class="mb-8">
        <h2>Select Your College</h2>
        <div class="college-grid">
          {% for college in colleges %}
            <a href="{% url 'select_college' college.slug %}" class="college-card">
              <div class="college-logo">
                {% if college.slug == 'ramdeo-baba-college' %}
                  <img src="{% static 'images/colleges/ramdeo-baba-logo.png' %}" alt="{{ college.name }}">
                {% elif college.slug == 'gh-raisoni-college' %}
                  <img src="{% static 'images/colleges/gh-raisoni-logo.png' %}" alt="{{ college.name }}">
                {% elif college.slug == 'ycce-college' %}
                  <img src="{% static 'images/colleges/ycce-logo.png' %}" alt="{{ college.name }}">
                {% else %}
                  <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4"></path>
                  </svg>
                {% endif %}
              </div>
              <div class="college-info">
                <h3 class="college-name">{{ college.name }}</h3>
                {% if college.address %}
                  <p class="college-address">{{ college.address|truncatewords:10 }}</p>
                {% endif %}
              </div>
              <div class="college-time">
                Est. {% if college.estimated_preparation_time %}{{ college.estimated_preparation_time }}{% else %}15{% endif %} min
              </div>
              <div class="college-select">
                Select College
                <svg width="16" height="16" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path>
                </svg>
              </div>
            </a>
          {% endfor %}
        </div>
      </div>
    {% else %}
      <!-- No colleges available -->
      <div class="mb-8">
        <div class="card" style="max-width: 32rem; margin: 0 auto;">
          <div class="flex items-center">
            <svg width="24" height="24" fill="none" stroke="currentColor" viewBox="0 0 24 24" style="color: #d97706; margin-right: 0.75rem;">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-2.5L13.732 4c-.77-.833-1.964-.833-2.732 0L3.732 16.5c-.77.833.192 2.5 1.732 2.5z"></path>
            </svg>
            <div>
              <h3 style="color: #92400e;">No Colleges Available</h3>
              <p style="color: #92400e;">There are currently no active colleges in the system. Please contact the administrator.</p>
            </div>
          </div>
        </div>
      </div>
    {% endif %}

    <!-- Super Admin Link (only for superusers) -->
    {% if user.is_superuser %}
      <div class="mb-8">
        <a href="{% url 'super_admin_dashboard' %}" class="btn btn-danger">
          <svg width="20" height="20" fill="none" stroke="currentColor" viewBox="0 0 24 24" style="margin-right: 0.5rem;">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m5.618-4.016A11.955 11.955 0 0112 2.944a11.955 11.955 0 01-8.618 3.04A12.02 12.02 0 003 9c0 5.591 3.824 10.29 9 11.622 5.176-1.332 9-6.03 9-11.622 0-1.042-.133-2.052-.382-3.016z"></path>
          </svg>
          Super Admin Dashboard
        </a>
      </div>
    {% endif %}

    <!-- Features -->
    <div class="features">
      <div class="features-grid">
        <div class="feature-item">
          <div class="feature-icon">
            <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"></path>
            </svg>
          </div>
          <h3>Fast Ordering</h3>
          <p>Order in seconds, skip the long queues</p>
        </div>
        
        <div class="feature-item">
          <div class="feature-icon">
            <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
            </svg>
          </div>
          <h3>Real-time Tracking</h3>
          <p>Track your order status in real-time</p>
        </div>
        
        <div class="feature-item">
          <div class="feature-icon">
            <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4.318 6.318a4.5 4.5 0 000 6.364L12 20.364l7.682-7.682a4.5 4.5 0 00-6.364-6.364L12 7.636l-1.318-1.318a4.5 4.5 0 00-6.364 0z"></path>
            </svg>
          </div>
          <h3>Favorite Items</h3>
          <p>Save your favorite meals for quick ordering</p>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Contact Section -->
<div class="footer">
  <div class="footer-content">
    <h2 style="text-align: center; margin-bottom: 2rem;">Contact Us</h2>
    <div class="footer-grid">
      <div class="footer-section">
        <div style="width: 3rem; height: 3rem; background: rgba(255,255,255,0.1); border-radius: 50%; display: flex; align-items: center; justify-content: center; margin: 0 auto 1rem;">
          <svg width="24" height="24" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 8l7.89 4.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"></path>
          </svg>
        </div>
        <h3>Email Support</h3>
        <p>skipthequeue.app@gmail.com</p>
      </div>
      
      <div class="footer-section">
        <div style="width: 3rem; height: 3rem; background: rgba(255,255,255,0.1); border-radius: 50%; display: flex; align-items: center; justify-content: center; margin: 0 auto 1rem;">
          <svg width="24" height="24" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8.228 9c.549-1.165 2.03-2 3.772-2 2.21 0 4 1.343 4 3 0 1.4-1.278 2.575-3.006 2.907-.542.104-.994.54-.994 1.093m0 3h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
          </svg>
        </div>
        <h3>Help Center</h3>
        <a href="{% url 'help_center' %}">Get Help</a>
      </div>
    </div>
  </div>
</div>

<script>
// Enhanced Order Status Tracking System
class EnhancedOrderTracker {
    constructor() {
        this.activeOrders = new Map();
        this.checkInterval = null;
        this.notificationCheckInterval = null;
        this.init();
    }

    init() {
        // Check for active orders on page load
        this.checkActiveOrders();
        this.checkForNotifications();
        
        // Set up periodic checking for order status updates
        this.checkInterval = setInterval(() => {
            this.checkActiveOrders();
        }, 30000); // Check every 30 seconds
        
        // Check for notifications more frequently
        this.notificationCheckInterval = setInterval(() => {
            this.checkForNotifications();
        }, 10000); // Check every 10 seconds
    }

    async checkActiveOrders() {
        const userPhone = '{{ request.session.user_phone }}';
        if (!userPhone) return;
        
        try {
            // Get active orders from localStorage or make API call
            const activeOrders = JSON.parse(localStorage.getItem('activeOrders') || '[]');
            
            if (activeOrders.length > 0) {
                // Check the most recent active order
                const latestOrder = activeOrders[0];
                this.updateOrderStatusBar(latestOrder);
            } else {
                // Hide status bar if no active orders
                this.hideOrderStatus();
            }
        } catch (error) {
            console.error('Error checking active orders:', error);
        }
    }

    async checkForNotifications() {
        const userPhone = '{{ request.session.user_phone }}';
        if (!userPhone) return;
        
        try {
            // Check if there are any pending notifications for this user
            const response = await fetch(`/check-notifications/?phone=${userPhone}`);
            if (response.ok) {
                const notifications = await response.json();
                
                for (const notification of notifications) {
                    if (notification.requires_user_action && notification.new_status === 'Ready') {
                        this.showOrderReadyNotification(notification);
                    } else {
                        this.updateOrderStatusBar(notification);
                    }
                }
            }
        } catch (error) {
            console.error('Error checking notifications:', error);
        }
    }

    updateOrderStatusBar(order) {
        const statusContainer = document.getElementById('order-status-container');
        const statusBar = document.getElementById('order-status-bar');
        const statusTitle = document.getElementById('status-title');
        const statusMessage = document.getElementById('status-message');
        
        if (!statusContainer || !statusBar || !statusTitle || !statusMessage) return;
        
        // Update status bar appearance based on order status
        statusBar.className = 'order-status-bar';
        
        if (order.status === 'Ready') {
            statusBar.classList.add('status-ready');
            statusTitle.textContent = 'ðŸŽ‰ Order Ready for Pickup!';
            statusMessage.textContent = `Order #${order.id} is ready at ${order.college_name || 'your college'}`;
        } else if (order.status === 'In Progress') {
            statusBar.classList.add('status-preparing');
            statusTitle.textContent = 'ðŸ‘¨â€ðŸ³ Order Being Prepared';
            statusMessage.textContent = `Order #${order.id} is being prepared at ${order.college_name || 'your college'}`;
        } else if (order.status === 'Completed') {
            statusBar.classList.add('status-completed');
            statusTitle.textContent = 'âœ… Order Completed';
            statusMessage.textContent = `Order #${order.id} has been completed`;
        } else {
            statusBar.classList.add('status-preparing');
            statusTitle.textContent = 'ðŸ“‹ Order Status';
            statusMessage.textContent = `Order #${order.id} - ${order.status}`;
        }
        
        // Show the status bar
        statusContainer.style.display = 'block';
    }

    showOrderReadyNotification(notification) {
        const notificationContainer = document.getElementById('order-ready-notification');
        const title = document.getElementById('ready-notification-title');
        const message = document.getElementById('ready-notification-message');
        
        if (notificationContainer && title && message) {
            title.textContent = notification.user_notification?.title || 'ðŸŽ‰ Order Ready for Pickup!';
            message.textContent = notification.user_notification?.message || `Order #${notification.order_id} is ready!`;
            notificationContainer.style.display = 'block';
            
            // Store in localStorage that this notification was shown
            localStorage.setItem(`order_ready_${notification.order_id}`, 'shown');
        }
    }

    hideOrderStatus() {
        const statusContainer = document.getElementById('order-status-container');
        if (statusContainer) {
            statusContainer.style.display = 'none';
        }
    }

    hideOrderReadyNotification() {
        const notificationContainer = document.getElementById('order-ready-notification');
        if (notificationContainer) {
            notificationContainer.style.display = 'none';
        }
    }
}

// Initialize enhanced order tracker
document.addEventListener('DOMContentLoaded', function() {
    if ('{{ user.is_authenticated }}' === 'True') {
        window.orderTracker = new EnhancedOrderTracker();
    }
});

// Global functions for template access
function hideOrderStatus() {
    if (window.orderTracker) {
        window.orderTracker.hideOrderStatus();
    }
}

function hideOrderReadyNotification() {
    if (window.orderTracker) {
        window.orderTracker.hideOrderReadyNotification();
    }
}

// Listen for order status updates from other pages
window.addEventListener('storage', function(e) {
    if (e.key === 'activeOrders') {
        const activeOrders = JSON.parse(e.newValue || '[]');
        if (activeOrders.length > 0 && window.orderTracker) {
            window.orderTracker.updateOrderStatusBar(activeOrders[0]);
        } else if (window.orderTracker) {
            window.orderTracker.hideOrderStatus();
        }
    }
});

// Listen for order status updates from service worker
if ('serviceWorker' in navigator) {
    navigator.serviceWorker.addEventListener('message', function(event) {
        if (event.data && event.data.type === 'ORDER_STATUS_UPDATE') {
            if (window.orderTracker) {
                window.orderTracker.updateOrderStatusBar(event.data.order);
            }
        }
    });
}

// Handle page visibility changes to check for updates when user returns to tab
document.addEventListener('visibilitychange', function() {
    if (!document.hidden && window.orderTracker) {
        window.orderTracker.checkForNotifications();
        window.orderTracker.checkActiveOrders();
    }
});
</script>
{% endblock %}
